<!-- Copyright (c) 2015 Google Inc. All rights reserved. -->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../google-apis/google-maps-api.html">
<link rel="import" href="google-map-marker.html">
<!--
The `google-map` element renders a Google Map.

<b>Example</b>:

    <style>
      google-map {
        height: 600px;
      }
    </style>
    <google-map latitude="37.77493" longitude="-122.41942"></google-map>

<b>Example</b> - add markers to the map and ensure they're in view:

    <google-map latitude="37.77493" longitude="-122.41942" fit-to-markers>
      <google-map-marker latitude="37.779" longitude="-122.3892"
          draggable="true" title="Go Giants!"></google-map-marker>
      <google-map-marker latitude="37.777" longitude="-122.38911"></google-map-marker>
    </google-map>

<b>Example</b>:

    <google-map disable-default-ui show-center-marker zoom="15"></google-map>
    <script>
      var map = document.querySelector('google-map');
      map.latitude = 37.77493;
      map.longitude = -122.41942;
      map.addEventListener('google-map-ready', function(e) {
        alert('Map loaded!');
      });
    </script>

<b>Example</b> - with Google directions, using data-binding inside another Polymer element

    <google-map map="{{map}}"></google-map>
    <google-map-directions map="{{map}}"
        start-address="San Francisco" end-address="Mountain View">
    </google-map-directions>

-->

<dom-module id="google-map">

    <style>
        :host {
            position: relative;
            display: block;
            height: 100%;
        }

        #map {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
    <template>
        <google-maps-api api-key="[[apiKey]]" client-id="[[clientId]]" version="[[version]]" libraries="[[libraries]]" signed-in="[[signedIn]]" language="[[language]]" on-api-load="_mapApiLoaded"></google-maps-api>

        <div id="map"></div>

        <content id="markers" select="google-map-marker"></content>

    </template>
</dom-module>

<script>
    //Style the Map
    var styleArray = [{
        featureType: "landscape",
        elementType: "geometry.fill",
        stylers: [{
            color: "#7f8c8d"
        }]
    }, {
        featureType: "poi",
        elementType: "geometry",
        stylers: [{
            color: "#2c3e50"
        }]

    }, {
        featureType: "poi.park",
        elementType: "geometry",
        stylers: [{
            color: "#2ecc71"
        }]
    }, {
        featureType: "poi.medical",
        elementType: "geometry",
        stylers: [{
            color: "#c0392b"
        }]
    }, {
        featureType: "road",
        elementType: "geometry",
        stylers: [{
            color: "#c0392b"
        }, {
            saturation: -50
        }]
    }, {
        featureType: "road",
        elementType: "labels",
        stylers: [{
            visibility: "off"
        }]
    }, {
        featureType: "poi",
        elementType: "labels",
        stylers: [{
            visibility: "off"
        }]
    }];

    var markersmarkers = [{
        "name": "Walk to the Hockey Game",
        "latitude": 34.150414,
        "longitude": -118.33694,
        "desc": "The guys walk to a hockey game, but Ross sees a peach pit on the sidewalk and remembers his first lesbian ex-wife",
        "search": "Friends Hennesy street Sitcom"
    }, {
        "name": "$1000 and a Football Phone",
        "latitude": 34.150767,
        "longitude": -118.33702,
        "desc": "Phoebe's bank accidentally gives her extra money that she wants to get rid of. She gives it to a homeless woman on Hennesy street street.",
        "search": "Friends Hennesy street Sitcom"
    }, {
        "name": "Phoebe Runs Weird",
        "latitude": 34.148936,
        "longitude": -118.33724,
        "desc": "Rachel is embarassed by Phoebe's crazy style of running.",
        "search": "Friends new york street Embassy court ct Sitcom"
    }, {
        "name": "Red Ross",
        "latitude": 34.149041,
        "longitude": -118.33690,
        "desc": "Ross plays rugby to impress his new British girlfriend.",
        "search": "Friends French street Sitcom"
    }, {
        "name": "Chandler Chases Kathy",
        "latitude": 34.150562,
        "longitude": -118.33692,
        "desc": "Chandler has a crush on Joey's girlfriend, who he chases down the street when she doesn't hear him say hello.",
        "search": "Friends Hennesy street Sitcom"
    }, {
        "name": "Ross gets Waterballooned",
        "latitude": 34.149554,
        "longitude": -118.33794,
        "desc": "Ross breaks up with his much younger girlfriend, Elizabeth. He is reconsidering when she starts throwing water balloons at him from her dorm room window.",
        "search": "Friends new york street Sitcom"
    }, {
        "name": "Stage 24",
        "latitude": 34.148928,
        "longitude": -118.33808,
        "desc": "The Friends Stage",
        "search": "Friends front lot Sitcom"
    }];
    var gilmoregirlspoi = [{
        "name": "Gilmore House",
        "latitude": 34.148066,
        "longitude": -118.33596,
        "desc": "Home of Lorelei and Rory Gilmore",
        "search": "gilmore girls kingsrow midw Drama"
    }, {
        "name": "Stars Hollow High",
        "latitude": 34.148492,
        "longitude": -118.33665,
        "desc": "School Rory attends for an episode or two.",
        "search": "gilmore girls midwest street Drama"
    }, {
        "name": "Gazebo",
        "latitude": 34.148628,
        "longitude": -118.33621,
        "desc": "Iconic landmark from the show.",
        "search": "gilmore girls midwest street Drama"
    }, {
        "name": "Weston's Bakery",
        "latitude": 34.148453,
        "longitude": -118.33693,
        "desc": "Town bakery",
        "search": "gilmore girls french street Drama"
    }, {
        "name": "Miss Patty's",
        "latitude": 34.148880,
        "longitude": -118.33696,
        "desc": "Rory and Jess fall asleep together here and stay out all night.",
        "search": "gilmore girls french street Drama"
    }, {
        "name": "Luke's Diner",
        "latitude": 34.149016,
        "longitude": -118.33662,
        "desc": "Coffee, please.",
        "search": "gilmore girls midwest street Drama"
    }, {
        "name": "Rory gets hit by a deer",
        "latitude": 34.149421,
        "longitude": -118.33411,
        "desc": "No. She was hit. Not she hit.",
        "search": "gilmore girls jungle Drama"
    }, {
        "name": "Doose's Market",
        "latitude": 34.148942,
        "longitude": -118.33626,
        "desc": "There's a good aisle inside.",
        "search": "gilmore girls midwest street Drama"
    }, {
        "name": "Hewes bros service station",
        "latitude": 34.148375,
        "longitude": -118.33572,
        "desc": "Car trouble?",
        "search": "gilmore girls midwest street Drama"
    }, {
        "name": "Bangles concert",
        "latitude": 34.149712,
        "longitude": -118.33839,
        "desc": "The Chilton girls abandon the concert and Lorelei has to go kick some ass.",
        "search": "gilmore girls new york brownstone street Drama"
    }, {
        "name": "Luke shoves Jess in the lake",
        "latitude": 34.149515,
        "longitude": -118.33419,
        "desc": "Exactly like it says.",
        "search": "gilmore girls jungle Drama"
    }, {
        "name": "Chilton Gates",
        "latitude": 34.149189,
        "longitude": -118.33742,
        "desc": "Also the museum where Emily goes on a date",
        "search": "gilmore girls new york street embassy court ct Drama"
    }];
    var pllpoi = [{
        "name": "Rory's Study Tree",
        "latitude": 34.149074,
        "longitude": -118.33717,
        "desc": "Peace and quiet at Yale",
        "search": "gilmore girls new york street embassy court ct Drama"
    }, {
        "name": "Spencer's House",
        "latitude": 34.148066,
        "longitude": -118.33596,
        "desc": "Home of Spencer Hastings, site of murders galore.",
        "search": "pretty little liars midwest street kingsrow Drama"
    }, {
        "name": "Rosewood High",
        "latitude": 34.148492,
        "longitude": -118.33665,
        "desc": "Sit outside and stare as Mona walks in.",
        "search": "pretty little liars midwest street Drama"
    }, {
        "name": "Apple Rose Grill",
        "latitude": 34.149016,
        "longitude": -118.33662,
        "desc": "Hungry?",
        "search": "pretty little liars midwest street Drama"
    }, {
        "name": "Hanna gets hit by a car",
        "latitude": 34.149421,
        "longitude": -118.33411,
        "desc": "And 1000 other things. They are in these woods a lot.",
        "search": "pretty little liars jungle Drama"
    }, {
        "name": "The Greenhouse Meeting with A",
        "latitude": 34.149515,
        "longitude": -118.33419,
        "desc": "The girls trick A into meeting with them and they end up getting his/her cell phone.",
        "search": "pretty little liars jungle Drama"
    }, {
        "name": "Radley Mental Institution",
        "latitude": 34.149189,
        "longitude": -118.33742,
        "desc": "The exterior of the mental institution that continually crops up in the main story.",
        "search": "pretty little liars new york street embassy court ct Drama"
    }, {
        "name": "Emily's House",
        "latitude": 34.148306,
        "longitude": -118.33598,
        "desc": "Home of Emily Fields",
        "search": "pretty little liars midwest street kingsrow Drama"
    }, {
        "name": "Rear Window Brew",
        "latitude": 34.149088,
        "longitude": -118.33619,
        "desc": "Ezra owns it. Emily works there.",
        "search": "pretty little liars midwest street Drama"
    }, {
        "name": "Church",
        "latitude": 34.148562,
        "longitude": -118.33585,
        "desc": "Finale of season 1 (exterior). Interior was shot inside the fire station across the square.",
        "search": "pretty little liars midwest street Drama"
    }, {
        "name": "Police Station/City Hall",
        "latitude": 34.148694,
        "longitude": -118.33655,
        "desc": "When are they not here?",
        "search": "pretty little liars midwest street Drama"
    }, {
        "name": "Abandoned house from season 2",
        "latitude": 34.148289,
        "longitude": -118.33644,
        "desc": "Ali takes them in to scare them",
        "search": "pretty little liars midwest street kingsrow Drama"
    }, {
        "name": "Aria's porch",
        "latitude": 34.148000,
        "longitude": -118.33645,
        "desc": "The rest of the house is in Canada",
        "search": "pretty little liars midwest street kingsrow Drama"
    }, {
        "name": "Hanna's House",
        "latitude": 34.148385,
        "longitude": -118.33333,
        "desc": "She lives far away from anyone else",
        "search": "pretty little liars warnervillage Drama"
    }, {
        "name": "Dilaurentis's House",
        "latitude": 34.149385,
        "longitude": -118.33373,
        "desc": "Built for this production",
        "search": "pretty little liars jungle Drama"
    }, {
        "name": "Ezra's Cabin",
        "latitude": 34.149892,
        "longitude": -118.33401,
        "desc": "A convenient hideaway",
        "search": "pretty little liars jungle Drama"
    }, {
        "name": "Ally's Memorial / Grave",
        "latitude": 34.148887,
        "longitude": -118.33732,
        "desc": "Right across the street from Radley",
        "search": "pretty little liars new york street embassy court ct Drama"
    }, {
        "name": "Stage 6",
        "latitude": 34.147422,
        "longitude": -118.34078,
        "desc": "The soundstage",
        "search": "pretty little liars front lot Drama"
    }, {
        "name": "Stages 7 and 8",
        "latitude": 34.147100,
        "longitude": -118.34051,
        "desc": "More soundstages",
        "search": "pretty little liars front lot Drama"
    }];
    var bigbangpoi = [{
        "name": "Stage 25",
        "latitude": 34.148416,
        "longitude": -118.33785,
        "desc": "The soundstage",
        "search": "big bang front lot sitcom"
    }, {
        "name": "Raiding Raiders of the Lost Arc",
        "latitude": 34.149561,
        "longitude": -118.33753,
        "desc": "Sheldon and the gang stand in line to see the movie, but Sheldon ends up stealing the print and running away.",
        "search": "big bang new york street sitcom"
    }, {
        "name": "Apartment Exterior",
        "latitude": 34.148282,
        "longitude": -118.33695,
        "desc": "The outside of the apartment building",
        "search": "big bang french street sitcom"
    }];
    var waters = [{
        "name": "Museum (water, restrooms)",
        "latitude": 34.150085,
        "longitude": -118.33877,
        "search": "water restroom"
    }, {
        "name": "Stage 9 (bathrooms and water)",
        "latitude": 34.147714,
        "longitude": -118.34037,
        "search": "water restroom"
    }, {
        "name": "Audience staging (water)",
        "latitude": 34.147538,
        "longitude": -118.33566,
        "search": "restroom"
    }, {
        "name": "Mill Store",
        "latitude": 34.147081,
        "longitude": -118.33918,
        "search": "water restroom soda food"
    }, {
        "name": "Stage 25 (soda machine and restrooms)",
        "latitude": 34.148210,
        "longitude": -118.33737,
        "search": "water restroom soda"
    }, {
        "name": "Parking/ Costumes (restrooms, soda on west side)",
        "latitude": 34.147790,
        "longitude": -118.33430,
        "search": "water restroom soda"
    }, {
        "name": "Commisary",
        "latitude": 34.149279,
        "longitude": -118.33922,
        "search": "water restroom soda"
    }, {
        "name": "Avon Grill",
        "latitude": 34.148892,
        "longitude": -118.33565,
        "search": "water restroom soda food"
    }, {
        "name": "Tan building (restroom)",
        "latitude": 34.149325,
        "longitude": -118.33433,
        "search": "restroom"
    }, {
        "name": "Restrooms near Dr. Ross end",
        "latitude": 34.150420,
        "longitude": -118.33638,
        "search": "restroom"
    }, {
        "name": "Post-Production (restrooms)",
        "latitude": 34.150277,
        "longitude": -118.33922,
        "search": "restroom"
    }, {
        "name": "Restrooms not for guests (Ellen's talent entrance)",
        "latitude": 34.148388,
        "longitude": -118.34173,
        "search": "restroom"
    }, {
        "name": "Restrooms at stage 21",
        "latitude": 34.147628,
        "longitude": -118.33852,
        "search": "restroom"
    }, {
        "name": "Bridge cafe",
        "latitude": 34.147937,
        "longitude": -118.33490,
        "search": "water restroom soda food"
    }];
    document.addEventListener("DOMContentLoaded", function(event) {
        Polymer({

            is: 'google-map',


            /**
             * Fired when the Maps API has fully loaded.
             * @event google-map-ready
             */
            /**
             * Fired when the when the user clicks on the map (but not when they click on a marker, infowindow, or
             * other object). Requires the clickEvents attribute to be true.
             * @event google-map-click
             * @param {google.maps.MouseEvent} event The mouse event.
             */
            /**
             * Fired when the user double-clicks on the map. Note that the google-map-click event will also fire,
             * right before this one. Requires the clickEvents attribute to be true.
             * @event google-map-dblclick
             * @param {google.maps.MouseEvent} event The mouse event.
             */
            /**
             * Fired repeatedly while the user drags the map. Requires the dragEvents attribute to be true.
             * @event google-map-drag
             */
            /**
             * Fired when the user stops dragging the map. Requires the dragEvents attribute to be true.
             * @event google-map-dragend
             */
            /**
             * Fired when the user starts dragging the map. Requires the dragEvents attribute to be true.
             * @event google-map-dragstart
             */
            /**
             * Fired whenever the user's mouse moves over the map container. Requires the mouseEvents attribute to
             * be true.
             * @event google-map-mousemove
             * @param {google.maps.MouseEvent} event The mouse event.
             */
            /**
             * Fired when the user's mouse exits the map container. Requires the mouseEvents attribute to be true.
             * @event google-map-mouseout
             * @param {google.maps.MouseEvent} event The mouse event.
             */
            /**
             * Fired when the user's mouse enters the map container. Requires the mouseEvents attribute to be true.
             * @event google-map-mouseover
             * @param {google.maps.MouseEvent} event The mouse event.
             */
            /**
             * Fired when the DOM `contextmenu` event is fired on the map container. Requires the clickEvents
             * attribute to be true.
             * @event google-map-rightclick
             * @param {google.maps.MouseEvent} event The mouse event.
             */
            properties: {
                /**
                 * A Maps API key. To obtain an API key, see developers.google.com/maps/documentation/javascript/tutorial#api_key.
                 */
                apiKey: String,

                /**
                 * A Maps API for Business Client ID. To obtain a Maps API for Business Client ID, see developers.google.com/maps/documentation/business/.
                 * If set, a Client ID will take precedence over an API Key.
                 */
                clientId: String,

                /**
                 * A latitude to center the map on.
                 */
                latitude: {
                    type: Number,
                    value: 34.148955,
                    notify: true,
                    reflectToAtrribute: true
                },

                /**
                 * A comma separated list (e.g. "places,geometry") of libraries to load
                 * with this map. Defaults to "places". For more information see
                 * https://developers.google.com/maps/documentation/javascript/libraries.
                 */
                libraries: {
                    type: String,
                    value: 'places'
                },

                /**
                 * A longitude to center the map on.
                 */
                longitude: {
                    type: Number,
                    value: -118.337912,
                    notify: true,
                    reflectToAtrribute: true
                },

                /**
                 * A zoom level to set the map to.
                 */
                zoom: {
                    type: Number,
                    value: 17,
                    observer: '_zoomChanged'
                },

                /**
                 * When set, prevents the map from tilting (when the zoom level and viewport supports it).
                 */
                noAutoTilt: {
                    type: Boolean,
                    value: false
                },

                /**
                 * Map type to display. One of 'roadmap', 'satellite', 'hybrid', 'terrain'.
                 */
                mapType: {
                    type: String,
                    value: 'roadmap', // roadmap, satellite, hybrid, terrain,
                    observer: '_mapTypeChanged'
                },

                /**
                 * Version of the Google Maps API to use.
                 */
                version: {
                    type: String,
                    value: '3.exp'
                },

                /**
                 * If set, removes the map's default UI controls.
                 */
                disableDefaultUi: {
                    type: Boolean,
                    value: false,
                    observer: '_disableDefaultUiChanged'
                },

                /**
                 * If set, the zoom level is set such that all markers (google-map-marker children) are brought into view.
                 */
                fitToMarkers: {
                    type: Boolean,
                    value: false,
                    observer: '_fitToMarkersChanged'
                },

                /**
                 * If false, prevent the user from zooming the map interactively.
                 */
                zoomable: {
                    type: Boolean,
                    value: true,
                    observer: '_zoomableChanged'
                },

                /**
                 * If set, custom styles can be applied to the map.
                 * For style documentation see developers.google.com/maps/documentation/javascript/reference#MapTypeStyle
                 */
                styles: {
                    type: Object,
                    value: styleArray
                },

                /**
                 * A maximum zoom level which will be displayed on the map.
                 */
                maxZoom: {
                    type: Number,
                    value: 20,
                    observer: '_maxZoomChanged'
                },

                /**
                 * A minimum zoom level which will be displayed on the map.
                 */
                minZoom: {
                    type: Number,
                    value: 17,
                    observer: '_minZoomChanged'
                },

                /**
                 * If true, sign-in is enabled.
                 * See https://developers.google.com/maps/documentation/javascript/signedin#enable_sign_in
                 */
                signedIn: {
                    type: Boolean,
                    value: false
                },

                /**
                 * The localized language to load the Maps API with. For more information
                 * see https://developers.google.com/maps/documentation/javascript/basics#Language
                 *
                 * Note: the Maps API defaults to the preffered language setting of the browser.
                 * Use this parameter to override that behavior.
                 */
                language: {
                    type: String
                },

                /**
                 * When true, map *click events are automatically registered.
                 */
                clickEvents: {
                    type: Boolean,
                    value: false,
                    observer: '_clickEventsChanged'
                },

                /**
                 * When true, map drag* events are automatically registered.
                 */
                dragEvents: {
                    type: Boolean,
                    value: false,
                    observer: '_dragEventsChanged'
                },

                /**
                 * When true, map mouse* events are automatically registered.
                 */
                mouseEvents: {
                    type: Boolean,
                    value: false,
                    observer: '_mouseEventsChanged'
                },

                /**
                 * Additional map options for google.maps.Map constructor.
                 * Use to specify additional options we do not expose as
                 * properties.
                 * Ex: `<google-map additional-map-options='{"mapTypeId":"satellite"}'>`
                 */
                additionalMapOptions: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                }

            },

            observers: [
                '_updateCenter(latitude longitude)'
            ],

            created: function() {
            this.markers = [];
            },

            attached: function() {
                this.resize();
            },

            detached: function() {
                if (this._mutationObserver) {
                    this._mutationObserver.disconnect();
                }
            },

            _mapApiLoaded: function() {
                this.map = new google.maps.Map(this.$.map, this._getMapOptions());

                this._listeners = {};
                this._updateCenter();
                this._updateMarkers();
                this._addMapListeners();

                this.fire('google-map-ready');
            },

            _getMapOptions: function() {
                var mapOptions = {
                    zoom: this.zoom,
                    tilt: this.noAutoTilt ? 0 : 45,
                    mapTypeId: this.mapType,
                    disableDefaultUI: this.disableDefaultUi,
                    disableDoubleClickZoom: !this.zoomable,
                    scrollwheel: this.zoomable,
                    styles: this.styles,
                    maxZoom: Number(this.maxZoom),
                    minZoom: Number(this.minZoom)
                };

                // Only override the default if set.
                // We use getAttribute here because the default value of this.draggable = false even when not set.
                if (this.getAttribute('draggable') != null) {
                    mapOptions.draggable = this.draggable;
                }
                for (var p in this.additionalMapOptions)
                    mapOptions[p] = this.additionalMapOptions[p];

                return mapOptions;
            },

            _updateMarkers: function() {
                this.markers = Array.prototype.slice.call(
                    Polymer.dom(this.$.markers).getDistributedNodes());

                // Watch for future updates.
                if (this._mutationObserver) {
                    this._mutationObserver.disconnect();
                }
                this._mutationObserver = new MutationObserver(this._updateMarkers.bind(this));
                this._mutationObserver.observe(this, {
                    childList: true,
                    subtree: true
                });

                // Set the map on each marker and zoom viewport to ensure they're in view.
                if (this.markers.length) {
                    for (var i = 0; i < this.markers.length; i++) {
                        this.markers[i].map = this.map;
                    }

                    if (this.fitToMarkers) {
                        this._fitToMarkersChanged();
                    }
                }
            },

            /**
             * Clears all markers from the map.
             *
             * @method clear
             */
            clear: function() {
                for (var i = 0, m; m = this.markers[i]; ++i) {
                    m.marker.setMap(null);
                }
            },

            /**
             * Explicitly resizes the map, updating its center. This is useful if the
             * map does not show after you have unhidden it.
             *
             * @method resize
             */
            resize: function() {
                if (this.map) {
                    google.maps.event.trigger(this.map, 'resize');
                    this._updateCenter();
                }
            },

            _updateCenter: function() {
                if (!this.map) {
                    return;
                } else if (typeof this.latitude !== 'number' || isNaN(this.latitude)) {
                    throw new TypeError('latitude must be a number');
                } else if (typeof this.longitude !== 'number' || isNaN(this.longitude)) {
                    throw new TypeError('longitude must be a number');
                }

                var newCenter = new google.maps.LatLng(this.latitude, this.longitude);
                var oldCenter = this.map.getCenter();

                if (!oldCenter) {
                    // If the map does not have a center, set it right away.
                    this.map.setCenter(newCenter);
                } else {
                    // Using google.maps.LatLng returns corrected lat/lngs.
                    oldCenter = new google.maps.LatLng(oldCenter.lat(), oldCenter.lng());

                    // If the map currently has a center, slowly pan to the new one.
                    if (!oldCenter.equals(newCenter)) {
                        this.map.panTo(newCenter);
                    }
                }
            },

            _zoomChanged: function() {
                if (this.map) {
                    this.map.setZoom(Number(this.zoom));
                }
            },

            _clickEventsChanged: function() {
                if (this.map && this.marker) {
                    if (this.clickEvents) {
                        this._forwardEvent('click');
                        this._forwardEvent('dblclick');
                        this._forwardEvent('rightclick');
                    } else {
                        this._clearListener('click');
                        this._clearListener('dblclick');
                        this._clearListener('rightclick');
                    }
                }
            },

            _dragEventsChanged: function() {
                if (this.map) {
                    if (this.dragEvents) {
                        this._forwardEvent('drag');
                        this._forwardEvent('dragend');
                        this._forwardEvent('dragstart');
                    } else {
                        this._clearListener('drag');
                        this._clearListener('dragend');
                        this._clearListener('dragstart');
                    }
                }
            },

            _mouseEventsChanged: function() {
                if (this.map && this.marker) {
                    if (this.mouseEvents) {
                        this._forwardEvent('mousemove');
                        this._forwardEvent('mouseout');
                        this._forwardEvent('mouseover');
                    } else {
                        this._clearListener('mousemove');
                        this._clearListener('mouseout');
                        this._clearListener('mouseover');
                    }
                }
            },

            _maxZoomChanged: function() {
                if (this.map) {
                    this.map.setOptions({
                        maxZoom: Number(this.maxZoom)
                    });
                }
            },

            _minZoomChanged: function() {
                if (this.map) {
                    this.map.setOptions({
                        minZoom: Number(this.minZoom)
                    });
                }
            },

            _mapTypeChanged: function() {
                if (this.map) {
                    this.map.setMapTypeId(this.mapType);
                }
            },

            _disableDefaultUiChanged: function() {
                if (!this.map) {
                    return;
                }
                this.map.setOptions({
                    disableDefaultUI: this.disableDefaultUi
                });
            },

            _zoomableChanged: function() {
                if (!this.map) {
                    return;
                }
                this.map.setOptions({
                    disableDoubleClickZoom: !this.zoomable,
                    scrollwheel: this.zoomable
                });
            },

            attributeChanged: function(attrName, oldVal, newVal) {
                if (!this.map) {
                    return;
                }
                // Cannot use *Changed watchers for native properties.
                switch (attrName) {
                    case 'draggable':
                        this.map.setOptions({
                            draggable: this.draggable
                        });
                        break;
                }
            },

            _fitToMarkersChanged: function() {
                // TODO(ericbidelman): respect user's zoom level.

                if (this.map && this.fitToMarkers) {
                    var latLngBounds = new google.maps.LatLngBounds();
                    for (var i = 0, m; m = this.markers[i]; ++i) {
                        latLngBounds.extend(
                            new google.maps.LatLng(m.latitude, m.longitude));
                    }

                    // For one marker, don't alter zoom, just center it.
                    if (this.markers.length > 1) {
                        this.map.fitBounds(latLngBounds);
                    }

                    this.map.setCenter(latLngBounds.getCenter());
                }
            },

            _addMapListeners: function() {
                google.maps.event.addListener(this.map, 'center_changed', function() {
                    var center = this.map.getCenter();
                    this.latitude = center.lat();
                    this.longitude = center.lng();
                }.bind(this));

                google.maps.event.addListener(this.map, 'zoom_changed', function() {
                    this.zoom = this.map.getZoom();
                }.bind(this));

                this._clickEventsChanged();
                this._dragEventsChanged();
                this._mouseEventsChanged();
            },

            _clearListener: function(name) {
                if (this._listeners[name]) {
                    google.maps.event.removeListener(this._listeners[name]);
                    this._listeners[name] = null;
                }
            },

            _forwardEvent: function(name) {
                this._listeners[name] = google.maps.event.addListener(this.map, name, function(event) {
                    this.fire('google-map-' + name, event);
                }.bind(this));
            }

        });
    });
</script>
